# üë• –†—É–∫–æ–≤–æ–¥—Å—Ç–≤–æ –ø–æ –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º

## üìä –í–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ —Å–∏—Å—Ç–µ–º—ã

### –õ–∏–º–∏—Ç—ã –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é:
- **–ú–∞–∫—Å–∏–º—É–º —Å–µ—Å—Å–∏–π –Ω–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è**: 3
- **–û–±—â–∏–π –ª–∏–º–∏—Ç —Å–µ—Å—Å–∏–π**: 50
- **–í—Ä–µ–º—è –Ω–µ–∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏**: 30 –º–∏–Ω—É—Ç
- **–ê–≤—Ç–æ–æ—á–∏—Å—Ç–∫–∞**: –∫–∞–∂–¥—ã–µ 5 –º–∏–Ω—É—Ç

## üîß –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ª–∏–º–∏—Ç–æ–≤

### –í .env —Ñ–∞–π–ª–µ:
```env
MAX_SESSIONS_PER_USER=3
MAX_TOTAL_SESSIONS=50
SESSION_TIMEOUT=1800000
```

### –ß–µ—Ä–µ–∑ –∫–æ–¥:
```javascript
// –ò–∑–º–µ–Ω–µ–Ω–∏–µ –ª–∏–º–∏—Ç–æ–≤ –≤–æ –≤—Ä–µ–º—è —Ä–∞–±–æ—Ç—ã
sessionManager.setLimits({
    maxSessionsPerUser: 5,
    maxTotalSessions: 100,
    sessionTimeout: 60 * 60 * 1000 // 1 —á–∞—Å
});
```

## üìà API –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏

### GET /api/sessions/stats
–ü–æ–ª—É—á–µ–Ω–∏–µ –æ–±—â–µ–π —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏:
```json
{
  "totalUsers": 15,
  "totalSessions": 28,
  "maxSessionsPerUser": 3,
  "maxTotalSessions": 50,
  "activeUsers": [
    {
      "userId": "123456789",
      "sessionCount": 2,
      "sessions": ["webapp_123456789_1640995200000", "webapp_123456789_1640995300000"]
    }
  ]
}
```

### GET /api/user/:userId/sessions
–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Å–µ—Å—Å–∏—è—Ö –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:
```json
{
  "userId": "123456789",
  "sessionCount": 2,
  "sessions": ["webapp_123456789_1640995200000"],
  "maxSessions": 3,
  "canCreateMore": true
}
```

### POST /api/webapp/start-session
–°–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤–æ–π —Å–µ—Å—Å–∏–∏ —Å –ø—Ä–æ–≤–µ—Ä–∫–æ–π –ª–∏–º–∏—Ç–æ–≤:
```json
{
  "deviceType": "mobile",
  "userId": "123456789"
}
```

–û—Ç–≤–µ—Ç:
```json
{
  "success": true,
  "sessionId": "webapp_123456789_1640995200000",
  "userId": "123456789",
  "userInfo": {
    "userId": "123456789",
    "sessionCount": 1,
    "canCreateMore": true
  },
  "deviceType": "mobile",
  "viewport": {
    "width": 390,
    "height": 844,
    "deviceScaleFactor": 3,
    "isMobile": true,
    "hasTouch": true
  }
}
```

### POST /api/webapp/end-session
–ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ —Å–µ—Å—Å–∏–∏ —Å –ø—Ä–æ–≤–µ—Ä–∫–æ–π –≤–ª–∞–¥–µ–ª—å—Ü–∞:
```json
{
  "sessionId": "webapp_123456789_1640995200000",
  "userId": "123456789"
}
```

## üõ°Ô∏è –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å –∏ –∏–∑–æ–ª—è—Ü–∏—è

### –ò–∑–æ–ª—è—Ü–∏—è —Å–µ—Å—Å–∏–π:
- ‚úÖ –ö–∞–∂–¥–∞—è —Å–µ—Å—Å–∏—è –≤ –æ—Ç–¥–µ–ª—å–Ω–æ–º –±—Ä–∞—É–∑–µ—Ä–Ω–æ–º –ø—Ä–æ—Ü–µ—Å—Å–µ
- ‚úÖ –£–Ω–∏–∫–∞–ª—å–Ω–∞—è –≤—Ä–µ–º–µ–Ω–Ω–∞—è –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—è `/tmp/browser-session-{sessionId}`
- ‚úÖ –û—Ç–¥–µ–ª—å–Ω—ã–µ cookies –∏ localStorage
- ‚úÖ –ù–µ–∑–∞–≤–∏—Å–∏–º—ã–µ User-Agent –∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏

### –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–∞:
```javascript
// –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–∏–Ω–∞–¥–ª–µ–∂–Ω–æ—Å—Ç–∏ —Å–µ—Å—Å–∏–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
if (!sessionManager.isUserSession(userId, sessionId)) {
    return res.status(403).json({
        success: false,
        error: '–ù–µ—Ç –¥–æ—Å—Ç—É–ø–∞ –∫ –¥–∞–Ω–Ω–æ–π —Å–µ—Å—Å–∏–∏'
    });
}
```

## üìä –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥

### WebSocket —Å–æ–±—ã—Ç–∏—è:
```javascript
// –ü–æ–¥–ø–∏—Å–∫–∞ –Ω–∞ —Å–æ–±—ã—Ç–∏—è SessionManager
sessionManager.on('sessionCreated', ({ userId, sessionId }) => {
    console.log(`–ù–æ–≤–∞—è —Å–µ—Å—Å–∏—è ${sessionId} –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è ${userId}`);
});

sessionManager.on('sessionRemoved', ({ userId, sessionId }) => {
    console.log(`–£–¥–∞–ª–µ–Ω–∞ —Å–µ—Å—Å–∏—è ${sessionId} –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è ${userId}`);
});

sessionManager.on('cleanupRequested', () => {
    console.log('–ó–∞–ø—Ä–æ—Å –∞–≤—Ç–æ–æ—á–∏—Å—Ç–∫–∏ –Ω–µ–∞–∫—Ç–∏–≤–Ω—ã—Ö —Å–µ—Å—Å–∏–π');
});
```

### Telegram Bot –∫–æ–º–∞–Ω–¥—ã:
```javascript
// /status - –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Å–µ—Å—Å–∏—è—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
// /stop - –æ—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç –≤—Å–µ —Å–µ—Å—Å–∏–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
// /webapp - –∑–∞–ø—É—Å–∫–∞–µ—Ç –Ω–æ–≤—É—é —Å–µ—Å—Å–∏—é —Å –ø—Ä–æ–≤–µ—Ä–∫–æ–π –ª–∏–º–∏—Ç–æ–≤
```

## ‚ö° –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ

### –ê–≤—Ç–æ–æ—á–∏—Å—Ç–∫–∞:
- ‚úÖ –ö–∞–∂–¥—ã–µ 5 –º–∏–Ω—É—Ç –ø—Ä–æ–≤–µ—Ä–∫–∞ –Ω–µ–∞–∫—Ç–∏–≤–Ω—ã—Ö —Å–µ—Å—Å–∏–π
- ‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —É–¥–∞–ª–µ–Ω–∏–µ —Å–µ—Å—Å–∏–π —Å—Ç–∞—Ä—à–µ 30 –º–∏–Ω—É—Ç
- ‚úÖ –û—á–∏—Å—Ç–∫–∞ –≤—Ä–µ–º–µ–Ω–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤ –∏ —Ä–µ—Å—É—Ä—Å–æ–≤
- ‚úÖ –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—á–µ—Ç—á–∏–∫–æ–≤ SessionManager

### –°–æ–±—ã—Ç–∏—è –æ—á–∏—Å—Ç–∫–∏:
```javascript
// –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–∞—è –æ—á–∏—Å—Ç–∫–∞ –≤—Å–µ—Ö —Å–µ—Å—Å–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
sessionManager.forceCleanupUser(userId);

// –û–±—Ä–∞–±–æ—Ç–∫–∞ —Å–æ–±—ã—Ç–∏—è –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–π –æ—á–∏—Å—Ç–∫–∏
sessionManager.on('forceCleanup', async ({ userId, sessionId }) => {
    await webAppManager.stopSession(sessionId);
});
```

## üö¶ –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫

### –ü—Ä–µ–≤—ã—à–µ–Ω–∏–µ –ª–∏–º–∏—Ç–æ–≤:
```json
{
  "success": false,
  "error": "–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å 123456789 –¥–æ—Å—Ç–∏–≥ –ª–∏–º–∏—Ç–∞ —Å–µ—Å—Å–∏–π (3)"
}
```

### –û–±—â–∏–π –ª–∏–º–∏—Ç:
```json
{
  "success": false,
  "error": "–î–æ—Å—Ç–∏–≥–Ω—É—Ç –ª–∏–º–∏—Ç –æ–±—â–µ–≥–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ —Å–µ—Å—Å–∏–π"
}
```

### –î–æ—Å—Ç—É–ø –∑–∞–ø—Ä–µ—â–µ–Ω:
```json
{
  "success": false,
  "error": "–ù–µ—Ç –¥–æ—Å—Ç—É–ø–∞ –∫ –¥–∞–Ω–Ω–æ–π —Å–µ—Å—Å–∏–∏"
}
```

## üì± Telegram Web App –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è

### –ü–æ–ª—É—á–µ–Ω–∏–µ userId:
```javascript
// –í webapp.html
const userId = tg?.initDataUnsafe?.user?.id || 'anonymous';
```

### –°–æ–∑–¥–∞–Ω–∏–µ —Å–µ—Å—Å–∏–∏:
```javascript
const response = await fetch('/api/webapp/start-session', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({
        deviceType: getDeviceType(),
        userId: userId
    })
});
```

### –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –ª–∏–º–∏—Ç–æ–≤ –≤ UI:
```javascript
if (data.userInfo) {
    console.log(`–°–µ—Å—Å–∏–π: ${data.userInfo.sessionCount}/${data.userInfo.maxSessions}`);
    console.log(`–ú–æ–∂–Ω–æ —Å–æ–∑–¥–∞—Ç—å –µ—â–µ: ${data.userInfo.canCreateMore}`);
}
```

## üîß –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏

### –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –¥–ª—è –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π:
```yaml
# docker-compose.yml
services:
  web3-tor-app:
    deploy:
      resources:
        limits:
          memory: 4G
          cpus: '2.0'
    environment:
      - MAX_SESSIONS_PER_USER=2
      - MAX_TOTAL_SESSIONS=30
```

### –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ —Ä–µ—Å—É—Ä—Å–æ–≤:
```bash
# –ü—Ä–æ–≤–µ—Ä–∫–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –ø–∞–º—è—Ç–∏
docker stats

# –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∞–∫—Ç–∏–≤–Ω—ã—Ö —Å–µ—Å—Å–∏–π
curl http://localhost:3000/api/sessions/stats
```

## ‚ö†Ô∏è –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏

1. **–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥**: –†–µ–≥—É–ª—è—Ä–Ω–æ –ø—Ä–æ–≤–µ—Ä—è–π—Ç–µ `/api/sessions/stats`
2. **–õ–∏–º–∏—Ç—ã**: –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–π—Ç–µ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ä–µ—Å—É—Ä—Å–æ–≤ —Å–µ—Ä–≤–µ—Ä–∞
3. **–û—á–∏—Å—Ç–∫–∞**: –£–±–µ–¥–∏—Ç–µ—Å—å —á—Ç–æ –∞–≤—Ç–æ–æ—á–∏—Å—Ç–∫–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç
4. **–õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ**: –û—Ç—Å–ª–µ–∂–∏–≤–∞–π—Ç–µ —Å–æ–∑–¥–∞–Ω–∏–µ/—É–¥–∞–ª–µ–Ω–∏–µ —Å–µ—Å—Å–∏–π
5. **–†–µ—Å—É—Ä—Å—ã**: –ö–∞–∂–¥–∞—è —Å–µ—Å—Å–∏—è ~200-500MB RAM

---

**–°–∏—Å—Ç–µ–º–∞ –≥–æ—Ç–æ–≤–∞ –¥–ª—è –ø–æ–¥–¥–µ—Ä–∂–∫–∏ –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π —Å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–º —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ–º —Ä–µ—Å—É—Ä—Å–∞–º–∏ –∏ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å—é!** üéâ
